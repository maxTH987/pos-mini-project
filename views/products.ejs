<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ - POS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-light">

<%- include('navbar') %>

<% 
    let totalItems = products.length;
    let totalInventoryValue = 0;
    let lowStockCount = 0;
    let outOfStockCount = 0;

    products.forEach(p => {
        totalInventoryValue += (p.cost * p.stock);
        if (p.stock === 0) {
            outOfStockCount++;
        } else if (p.stock <= 5) {
            lowStockCount++;
        }
    });
%>

<div class="container mt-4 mb-5">
    
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white shadow-sm border-0 h-100">
                <div class="card-body">
                    <h6 class="card-title"><i class="fa-solid fa-box me-2"></i>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h6>
                    <h2 class="mb-0 fw-bold"><%= totalItems %> <span class="fs-6 fw-normal">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span></h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white shadow-sm border-0 h-100">
                <div class="card-body">
                    <h6 class="card-title"><i class="fa-solid fa-sack-dollar me-2"></i>‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏á‡∏Ñ‡∏•‡∏±‡∏á (‡∏ó‡∏∏‡∏ô)</h6>
                    <h2 class="mb-0 fw-bold"><%= totalInventoryValue.toLocaleString() %> <span class="fs-6 fw-normal">‡∏ö‡∏≤‡∏ó</span></h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-dark shadow-sm border-0 h-100">
                <div class="card-body">
                    <h6 class="card-title"><i class="fa-solid fa-triangle-exclamation me-2"></i>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î</h6>
                    <h2 class="mb-0 fw-bold"><%= lowStockCount %> <span class="fs-6 fw-normal">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span></h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-danger text-white shadow-sm border-0 h-100">
                <div class="card-body">
                    <h6 class="card-title"><i class="fa-solid fa-circle-xmark me-2"></i>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î‡∏™‡∏ï‡πä‡∏≠‡∏Å</h6>
                    <h2 class="mb-0 fw-bold"><%= outOfStockCount %> <span class="fs-6 fw-normal">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span></h2>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-md-3">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-dark text-white fw-bold"><i class="fa-solid fa-plus me-2"></i>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</div>
                <div class="card-body">
                    <form onsubmit="addProduct(event)">
                        <div class="mb-2"><label class="fw-bold">‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î</label><input type="text" id="barcode" class="form-control" required></div>
                        <div class="mb-2"><label class="fw-bold">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label><input type="text" id="name" class="form-control" required></div>
                        <div class="mb-2"><label class="fw-bold">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏∏‡∏ô</label><input type="number" id="cost" class="form-control" required min="0"></div>
                        <div class="mb-2"><label class="fw-bold">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢</label><input type="number" id="price" class="form-control" required min="0"></div>
                        <div class="mb-2"><label class="fw-bold">‡∏™‡∏ï‡πä‡∏≠‡∏Å</label><input type="number" id="stock" class="form-control" required min="0"></div>
                        <div class="mb-2"><label class="fw-bold">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label><input type="text" id="category" class="form-control" required></div>
                        <div class="mb-3"><label class="fw-bold">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label><input type="text" id="description" class="form-control"></div>
                        
                        <div class="card p-2 mb-3 bg-light border-0">
                            <label class="fw-bold text-primary mb-1"><i class="fa-solid fa-image me-1"></i>‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                            <input type="file" id="imageFile" class="form-control mb-2" accept="image/*">
                            <div class="text-center text-muted mb-1" style="font-size: 0.8rem;">‡∏´‡∏£‡∏∑‡∏≠</div>
                            <input type="text" id="imageUrl" class="form-control" placeholder="‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ (URL)">
                        </div>

                        <button type="submit" class="btn btn-primary w-100 fw-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-9">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-info text-white fw-bold"><i class="fa-solid fa-list me-2"></i>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏£‡πâ‡∏≤‡∏ô</div>
                <div class="card-body p-0">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="ps-3">‡∏£‡∏π‡∏õ</th>
                                <th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                                <th>‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</th>
                                <th>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢</th>
                                <th>‡∏Å‡∏≥‡πÑ‡∏£/‡∏ä‡∏¥‡πâ‡∏ô</th> <th>‡∏™‡∏ï‡πä‡∏≠‡∏Å</th>
                                <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% products.forEach(function(p) { %>
                                <% let profit = p.price - p.cost; %> <tr>
                                    <td class="ps-3 align-middle">
                                        <img src="<%= p.imageUrl %>" alt="img" style="width: 45px; height: 45px; object-fit: cover; border-radius: 5px; border: 1px solid #dee2e6;">
                                    </td>
                                    <td class="align-middle">
                                        <div class="fw-bold text-dark"><%= p.name %></div>
                                        <span class="badge bg-secondary" style="font-size: 0.7rem;"><%= p.category %></span>
                                    </td>
                                    <td class="align-middle text-muted"><%= p.cost %> ‡∏ø</td>
                                    <td class="align-middle text-primary fw-bold"><%= p.price %> ‡∏ø</td>
                                    <td class="align-middle text-success fw-bold">+ <%= profit %> ‡∏ø</td>
                                    <td class="align-middle">
                                        <% if(p.stock > 5) { %> 
                                            <span class="badge bg-success"><%= p.stock %></span> 
                                        <% } else if(p.stock > 0 && p.stock <= 5) { %> 
                                            <span class="badge bg-warning text-dark">‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î (<%= p.stock %>)</span> 
                                        <% } else { %> 
                                            <span class="badge bg-danger">‡∏´‡∏°‡∏î</span> 
                                        <% } %>
                                    </td>
                                    <td class="align-middle">
                                        <button class="btn btn-sm btn-warning fw-bold text-dark mb-1" onclick="editProduct('<%= p._id %>', `<%= p.name %>`, <%= p.cost %>, <%= p.price %>, <%= p.stock %>, `<%= p.imageUrl %>`)"><i class="fa-solid fa-pen-to-square"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                        <button class="btn btn-sm btn-danger fw-bold mb-1" onclick="deleteProduct('<%= p._id %>')"><i class="fa-solid fa-trash"></i> ‡∏•‡∏ö</button>
                                    </td>
                                </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    async function addProduct(e) {
        e.preventDefault();
        const formData = new FormData();
        formData.append('barcode', document.getElementById('barcode').value);
        formData.append('name', document.getElementById('name').value);
        formData.append('description', document.getElementById('description').value);
        formData.append('cost', document.getElementById('cost').value);
        formData.append('price', document.getElementById('price').value);
        formData.append('stock', document.getElementById('stock').value);
        formData.append('category', document.getElementById('category').value);
        formData.append('imageUrl', document.getElementById('imageUrl').value);

        const fileInput = document.getElementById('imageFile');
        if (fileInput.files[0]) formData.append('imageFile', fileInput.files[0]);

        const res = await fetch('/api/products', { method: 'POST', body: formData });
        if(res.ok) { Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success').then(() => window.location.reload()); } 
        else { Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡∏ã‡πâ‡∏≥ ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', 'error'); }
    }

    async function editProduct(id, name, cost, price, stock, imageUrl) {
        const { value: formValues } = await Swal.fire({
            title: '‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤',
            html:
                `<label class="text-start w-100 fw-bold mt-2">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>` +
                `<input id="swal-name" class="swal2-input mt-0 mb-2" value="${name}">` +
                `<div class="d-flex gap-2">` +
                    `<div class="w-50"><label class="text-start w-100 fw-bold mt-2">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô</label><input id="swal-cost" type="number" class="form-control mt-0" value="${cost}"></div>` +
                    `<div class="w-50"><label class="text-start w-100 fw-bold mt-2">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢</label><input id="swal-price" type="number" class="form-control mt-0" value="${price}"></div>` +
                `</div>` +
                `<label class="text-start w-100 fw-bold mt-2">‡∏™‡∏ï‡πä‡∏≠‡∏Å</label>` +
                `<input id="swal-stock" type="number" class="swal2-input mt-0 mb-2" value="${stock}">` +
                `<div class="card p-2 mt-3 bg-light text-start">`+
                `<label class="fw-bold text-primary mb-1">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏´‡∏°‡πà (‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î)</label>` +
                `<input type="file" id="swal-file" class="form-control mb-2" accept="image/*">` +
                `<label class="fw-bold mb-1 mt-1">‡∏´‡∏£‡∏∑‡∏≠ ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏£‡∏π‡∏õ (URL)</label>` +
                `<input id="swal-img" class="form-control" value="${imageUrl}"></div>`,
            focusConfirm: false,
            showCancelButton: true,
            confirmButtonText: 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
            cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
            preConfirm: () => {
                return {
                    name: document.getElementById('swal-name').value,
                    cost: Number(document.getElementById('swal-cost').value),
                    price: Number(document.getElementById('swal-price').value),
                    stock: Number(document.getElementById('swal-stock').value),
                    imageUrl: document.getElementById('swal-img').value,
                    file: document.getElementById('swal-file').files[0]
                }
            }
        });

        if (formValues) {
            const formData = new FormData();
            formData.append('name', formValues.name);
            formData.append('cost', formValues.cost);
            formData.append('price', formValues.price);
            formData.append('stock', formValues.stock);
            formData.append('imageUrl', formValues.imageUrl);
            if (formValues.file) formData.append('imageFile', formValues.file);

            const res = await fetch(`/api/products/${id}`, { method: 'PUT', body: formData });
            if(res.ok) Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success').then(() => window.location.reload());
            else Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
        }
    }

    async function deleteProduct(id) {
        const result = await Swal.fire({ title: '‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ?', text: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏≤‡∏ß‡∏£!", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', cancelButtonColor: '#6c757d', confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡∏ö‡πÄ‡∏•‡∏¢!' });
        if (result.isConfirmed) {
            const res = await fetch(`/api/products/${id}`, { method: 'DELETE' });
            if(res.ok) Swal.fire('‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß!', '‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success').then(() => window.location.reload());
            else Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
        }
    }
</script>
</body>
</html>