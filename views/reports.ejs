<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>รายงานยอดขาย - POS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-light">

<%- include('navbar') %>

<div class="container mt-4 mb-5">
    <h3 class="mb-4 text-center fw-bold">รายงานสรุปยอดขายและกำไร</h3>

    <div class="card shadow-sm mb-4 border-0">
        <div class="card-body bg-white rounded">
            <form class="row align-items-end" onsubmit="fetchReport(event)">
                <div class="col-md-4 mb-3">
                    <label class="form-label fw-bold">ตั้งแต่วันที่ (Start Date)</label>
                    <input type="date" id="startDate" class="form-control" required>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label fw-bold">ถึงวันที่ (End Date)</label>
                    <input type="date" id="endDate" class="form-control" required>
                </div>
                <div class="col-md-4 mb-3">
                    <button type="submit" class="btn btn-primary w-100 py-2 fw-bold"><i class="fa-solid fa-magnifying-glass me-2"></i>ดึงข้อมูลรายงาน</button>
                </div>
            </form>
        </div>
    </div>

    <div class="row text-center mb-4" id="reportResult" style="display: none;">
        <div class="col-md-3 mb-3">
            <div class="card bg-info text-white shadow-sm border-0 h-100">
                <div class="card-body py-4">
                    <h6 class="card-title text-white-50">จำนวนบิลทั้งหมด</h6>
                    <h2 class="fw-bold mb-0" id="totalBills">0</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-primary text-white shadow-sm border-0 h-100" style="background: linear-gradient(135deg, #1e88e5, #1565c0) !important;">
                <div class="card-body py-4">
                    <h6 class="card-title text-white-50">ยอดขายสุทธิ (บาท)</h6>
                    <h2 class="fw-bold mb-0" id="totalSales">0</h2>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-3">
            <div class="card bg-primary text-white shadow-sm border-0 h-100" style="background: linear-gradient(135deg, #4ec854, #43a047) !important;">
                <div class="card-body py-4">
                    <h6 class="card-title text-white-50"> กำไรสุทธิ (บาท)</h6>
                    <h2 class="fw-bold mb-0" id="totalProfit">0</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card bg-secondary text-white shadow-sm border-0 h-100">
                <div class="card-body py-4">
                    <h6 class="card-title text-white-50">ส่วนลดรวม (บาท)</h6>
                    <h2 class="fw-bold mb-0" id="totalDiscount">0</h2>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm border-0 mb-4" id="topProductsContainer" style="display: none;">
        <div class="card-header bg-warning text-dark fw-bold" style="background: linear-gradient(135deg, #ffc107, #ffb300) !important;">
            <h5 class="mb-0"> 5 อันดับสินค้าขายดี (Top 5 Best Sellers)</h5>
        </div>
        <div class="card-body p-0 bg-white">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-3 text-center" style="width: 10%;">อันดับ</th>
                            <th>ชื่อสินค้า</th>
                            <th class="text-center">จำนวนที่ขายได้</th>
                            <th class="text-end pe-4">ยอดขายรวม (บาท)</th>
                        </tr>
                    </thead>
                    <tbody id="top-products-body">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="card shadow-sm border-0 mt-2" id="reportTableContainer" style="display: none;">
        <div class="card-header bg-dark text-white fw-bold">
            <h5 class="mb-0"><i class="fa-solid fa-receipt me-2"></i>รายละเอียดบิลที่ขายไป</h5>
        </div>
        <div class="card-body p-0 bg-white">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-3">วันที่ / เวลา</th>
                            <th>เลขที่ใบเสร็จ</th>
                            <th>รายการสินค้า (จำนวน x ราคา)</th>
                            <th>ส่วนลด</th>
                            <th>ยอดสุทธิ</th>
                        </tr>
                    </thead>
                    <tbody id="sales-table-body">
                        </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    async function fetchReport(e) {
        e.preventDefault();
        const start = document.getElementById('startDate').value;
        const end = document.getElementById('endDate').value;

        try {
            const res = await fetch(`/api/reports/sales?startDate=${start}&endDate=${end}`);
            const data = await res.json();

            if(res.ok) {
                // 1. โชว์ยอดรวม 4 อันด้านบน
                document.getElementById('reportResult').style.display = 'flex';
                document.getElementById('totalBills').innerText = data.summary.totalBills.toLocaleString();
                document.getElementById('totalSales').innerText = data.summary.totalSales.toLocaleString();
                document.getElementById('totalProfit').innerText = data.summary.totalProfit.toLocaleString();
                document.getElementById('totalDiscount').innerText = data.summary.totalDiscount.toLocaleString();

                // 2. โชว์ตาราง Top 5 สินค้าขายดี
                document.getElementById('topProductsContainer').style.display = 'block';
                const topBody = document.getElementById('top-products-body');
                topBody.innerHTML = '';
                
                if (data.topProducts.length === 0) {
                    topBody.innerHTML = `<tr><td colspan="4" class="text-center text-muted py-3">ยังไม่มีข้อมูลสินค้าขายดี</td></tr>`;
                } else {
                    data.topProducts.forEach((product, index) => {
                        let medal = index === 0 ? '1' : index === 1 ? '2' : index === 2 ? '3' : `${index + 1}.`;
                        topBody.innerHTML += `
                            <tr>
                                <td class="ps-3 text-center fw-bold fs-5">${medal}</td>
                                <td class="fw-bold">${product.name}</td>
                                <td class="text-center"><span class="badge bg-primary fs-6">${product.qty} ชิ้น</span></td>
                                <td class="text-end pe-4 text-success fw-bold">${product.totalAmount.toLocaleString()} ฿</td>
                            </tr>
                        `;
                    });
                }

                // 3. โชว์ตารางรายละเอียดบิลด้านล่าง
                document.getElementById('reportTableContainer').style.display = 'block';
                const tbody = document.getElementById('sales-table-body');
                tbody.innerHTML = '';

                if(data.details.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted py-4">ไม่พบข้อมูลการขายในช่วงเวลานี้</td></tr>`;
                    return;
                }

                data.details.forEach(sale => {
                    const dateObj = new Date(sale.createdAt);
                    const dateStr = `${dateObj.toLocaleDateString('th-TH')} ${dateObj.toLocaleTimeString('th-TH')}`;

                    let itemsHtml = sale.items.map(item => {
                        let productName = item.productId ? item.productId.name : 'สินค้าถูกลบ';
                        return `<div class="text-secondary">- ${productName} <span class="badge bg-light text-dark border">${item.qty} ชิ้น</span> (ชิ้นละ ${item.price}฿)</div>`;
                    }).join('');

                    tbody.innerHTML += `
                        <tr>
                            <td class="ps-3">${dateStr}</td>
                            <td><span class="badge bg-secondary">${sale.receiptNumber}</span></td>
                            <td>${itemsHtml}</td>
                            <td class="text-danger">${sale.discount > 0 ? '-' + sale.discount : '0'} ฿</td>
                            <td class="text-success fw-bold">${sale.netTotal} ฿</td>
                        </tr>
                    `;
                });

            } else {
                Swal.fire('ผิดพลาด', data.message || 'ไม่สามารถดึงข้อมูลได้', 'error');
            }
        } catch(error) {
            Swal.fire('ผิดพลาด', 'ไม่สามารถเชื่อมต่อเซิร์ฟเวอร์ได้', 'error');
        }
    }
</script>
</body>
</html>