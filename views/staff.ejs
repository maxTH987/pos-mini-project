<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô - POS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-light">

<%- include('navbar') %>

<div class="container mt-4 mb-5">
    <div class="row">
        <div class="col-md-4">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-dark text-white fw-bold"><i class="fa-solid fa-user-plus me-2"></i>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</div>
                <div class="card-body">
                    <form id="addStaffForm" onsubmit="addStaff(event)">
                        <div class="mb-2"><label class="fw-bold">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Username)</label><input type="text" id="username" class="form-control" required></div>
                        <div class="mb-2"><label class="fw-bold">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label><input type="password" id="password" class="form-control" required></div>
                        <div class="mb-2"><label class="fw-bold">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label><input type="text" id="name" class="form-control" required></div>
                        <div class="mb-3">
                            <label class="fw-bold">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (Role)</label>
                            <select id="role" class="form-select">
                                <option value="staff">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (Staff)</option>
                                <option value="owner">‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô (Owner)</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary w-100 fw-bold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-primary text-white fw-bold"><i class="fa-solid fa-users-gear me-2"></i>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</div>
                <div class="card-body p-0">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="ps-3">Username</th>
                                <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                                <th>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th>
                                <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th> </tr>
                        </thead>
                        <tbody>
                            <% staffList.forEach(function(staff) { %>
                                <tr>
                                    <td class="ps-3"><%= staff.username %></td>
                                    <td><%= staff.name %></td>
                                    <td>
                                        <% if(staff.role === 'owner') { %> <span class="badge bg-danger">Owner</span> 
                                        <% } else { %> <span class="badge bg-secondary">Staff</span> <% } %>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-warning text-dark fw-bold mb-1" 
                                            onclick="editStaff('<%= staff._id %>', '<%= staff.name %>', '<%= staff.role %>')">
                                            <i class="fa-solid fa-pen-to-square"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                                        </button>
                                        <button class="btn btn-sm btn-danger fw-bold mb-1" 
                                            onclick="deleteStaff('<%= staff._id %>')">
                                            <i class="fa-solid fa-trash"></i> ‡∏•‡∏ö
                                        </button>
                                    </td>
                                </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // 1. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
    async function addStaff(e) {
        e.preventDefault();
        const data = {
            username: document.getElementById('username').value,
            password: document.getElementById('password').value,
            name: document.getElementById('name').value,
            role: document.getElementById('role').value
        };
        const res = await fetch('/api/staff', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
        if(res.ok) { Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success').then(() => window.location.reload()); } 
        else { Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'Username ‡∏ã‡πâ‡∏≥ ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', 'error'); }
    }

    // 2. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
    async function editStaff(id, oldName, oldRole) {
        const { value: formValues } = await Swal.fire({
            title: '‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô',
            html:
                `<label class="text-start w-100 fw-bold mt-2">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>` +
                `<input id="swal-name" class="swal2-input mt-0 mb-2" value="${oldName}">` +
                `<label class="text-start w-100 fw-bold mt-2">‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</label>` +
                `<select id="swal-role" class="swal2-input mt-0 mb-2">
                    <option value="staff" ${oldRole === 'staff' ? 'selected' : ''}>Staff (‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ)</option>
                    <option value="owner" ${oldRole === 'owner' ? 'selected' : ''}>Owner (‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô)</option>
                </select>`,
            focusConfirm: false,
            showCancelButton: true,
            confirmButtonText: 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
            cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
            preConfirm: () => { return { name: document.getElementById('swal-name').value, role: document.getElementById('swal-role').value } }
        });

        if (formValues) {
            const res = await fetch(`/api/staff/${id}`, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(formValues) });
            if(res.ok) Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success').then(() => window.location.reload());
            else Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
        }
    }

    // 3. ‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
    async function deleteStaff(id) {
        const result = await Swal.fire({ 
            title: '‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?', 
            text: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£!", 
            icon: 'warning', 
            showCancelButton: true, 
            confirmButtonColor: '#d33', 
            cancelButtonColor: '#6c757d',
            confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏•‡∏ö‡πÄ‡∏•‡∏¢!',
            cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
        });
        if (result.isConfirmed) {
            const res = await fetch(`/api/staff/${id}`, { method: 'DELETE' });
            if(res.ok) Swal.fire('‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß!', '‡∏•‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success').then(() => window.location.reload());
            else Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏•‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ', 'error');
        }
    }
</script>
</body>
</html>